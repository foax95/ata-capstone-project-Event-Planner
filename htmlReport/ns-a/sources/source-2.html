


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > EndpointUtility</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.kenzie.capstone.service.client</a>
</div>

<h1>Coverage Summary for Class: EndpointUtility (com.kenzie.capstone.service.client)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EndpointUtility</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/110)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.kenzie.capstone.service.client;
&nbsp;
&nbsp;import com.amazonaws.services.apigateway.AmazonApiGateway;
&nbsp;import com.amazonaws.services.apigateway.AmazonApiGatewayClientBuilder;
&nbsp;import com.amazonaws.services.apigateway.model.GetRestApisRequest;
&nbsp;import com.amazonaws.services.apigateway.model.GetRestApisResult;
&nbsp;import com.amazonaws.services.apigateway.model.RestApi;
&nbsp;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileReader;
&nbsp;import java.io.IOException;
&nbsp;
&nbsp;import java.net.URI;
&nbsp;import java.net.http.HttpClient;
&nbsp;import java.net.http.HttpRequest;
&nbsp;import java.net.http.HttpResponse;
&nbsp;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.Paths;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;
&nbsp;public class EndpointUtility {
&nbsp;
<b class="nc">&nbsp;    public EndpointUtility() {</b>
<b class="nc">&nbsp;        String apiEndpoint = getApiEndpint();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /*
&nbsp;     * Returns input string with environment variable references expanded, e.g. $SOME_VAR or ${SOME_VAR}
&nbsp;     *
&nbsp;     * Gratefully adapted from Tim Lewis&#39;s answer on
&nbsp;     * https://stackoverflow.com/questions/2263929/regarding-application-properties-file-and-environment-variable
&nbsp;     */
&nbsp;    public static String resolveEnvVars(Map&lt;String,String&gt; envVars, String input) {
<b class="nc">&nbsp;        if (null == input) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;        // match ${ENV_VAR_NAME} or $ENV_VAR_NAME
<b class="nc">&nbsp;        Pattern p = Pattern.compile(&quot;\\$\\{(\\w+)\\}|\\$(\\w+)&quot;);</b>
<b class="nc">&nbsp;        Matcher m = p.matcher(input); // get a matcher object</b>
<b class="nc">&nbsp;        StringBuffer sb = new StringBuffer();</b>
<b class="nc">&nbsp;        while (m.find()) {</b>
<b class="nc">&nbsp;            String envVarName = null == m.group(1) ? m.group(2) : m.group(1);</b>
<b class="nc">&nbsp;            String envVarValue = envVars.get(envVarName);</b>
<b class="nc">&nbsp;            if (envVarValue == null) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Environment variable &quot; + envVarName +</b>
&nbsp;                        &quot; expected but not found or is null. Please set variable to a non-null value.&quot;);
&nbsp;            }
&nbsp;            //how the shell works natively
&nbsp;            //m.appendReplacement(sb, null == envVarValue ? &quot;&quot; : envVarValue);
<b class="nc">&nbsp;            m.appendReplacement(sb,envVarValue);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        m.appendTail(sb);</b>
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * Reads a line expecting an environment variable and resolves it if found.
&nbsp;     * If no environment variable is found, the line is skipped
&nbsp;     */
&nbsp;    public static Map&lt;String,String&gt; computeEnvVar(Map&lt;String,String&gt; envVars, String line){
<b class="nc">&nbsp;        String[] parts = line.trim().split(&quot;\\s+&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String,String&gt; newVars = new HashMap&lt;&gt;(envVars);</b>
&nbsp;
<b class="nc">&nbsp;        if (parts.length &gt; 1) {</b>
<b class="nc">&nbsp;            String[] var = parts[1].split(&quot;=&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            if (var.length &gt; 1) {</b>
<b class="nc">&nbsp;                String varName = var[0];</b>
<b class="nc">&nbsp;                String initVarValue = var[1];</b>
&nbsp;
<b class="nc">&nbsp;                String varValue = resolveEnvVars(envVars,initVarValue);</b>
<b class="nc">&nbsp;                newVars.put(varName,varValue);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return newVars;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * Finds the file from the relative path provided (relative to the project root)
&nbsp;     * and returns a copy of the map of environment variables with the ones found in the file added.
&nbsp;     *
&nbsp;     * Throws an IllegalArgumentException if the given file is not found.
&nbsp;     */
&nbsp;    public static Map&lt;String,String&gt; getEnvVariablesFromFile(Map&lt;String, String&gt; envVars, List&lt;String&gt; pathFromProjectRoot, String filename){
<b class="nc">&nbsp;        Path rootDir = Paths.get(&quot;.&quot;).normalize().toAbsolutePath().getParent();</b>
&nbsp;
<b class="nc">&nbsp;        Path path = rootDir;</b>
<b class="nc">&nbsp;        for (String pathPart : pathFromProjectRoot) {</b>
<b class="nc">&nbsp;            path = path.resolve(pathPart);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        path = path.normalize().resolve(filename);</b>
&nbsp;
&nbsp;
&nbsp;        BufferedReader reader;
&nbsp;
<b class="nc">&nbsp;        Map&lt;String,String&gt; newEnvVars = new HashMap&lt;&gt;(envVars);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            reader = new BufferedReader(new FileReader(path.toFile()));</b>
<b class="nc">&nbsp;            String line = reader.readLine();</b>
&nbsp;
<b class="nc">&nbsp;            while (line != null) {</b>
&nbsp;
<b class="nc">&nbsp;                if (line.startsWith(&quot;export &quot;)) {</b>
<b class="nc">&nbsp;                    newEnvVars = computeEnvVar(newEnvVars, line);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                line = reader.readLine();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            reader.close();</b>
<b class="nc">&nbsp;        } catch (FileNotFoundException e) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;File &quot; + path.toString() + &quot; not found.&quot;, e);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        return newEnvVars;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * Parses the setupEnvironment.sh file for all environment variables set within. Resolves using
&nbsp;     * the environment variables set in System.getenv() and any variables in the file in found order.
&nbsp;     * Since the file is at the root of the project, the path from the root is empty
&nbsp;     */
&nbsp;    public static String getEnvVarFromFile(String envVarName){
<b class="nc">&nbsp;        Map&lt;String,String&gt; envVars = System.getenv();</b>
<b class="nc">&nbsp;        List&lt;String&gt; pathToFile = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        String filename = &quot;setupEnvironment.sh&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        envVars = getEnvVariablesFromFile(envVars,pathToFile,filename);</b>
&nbsp;
<b class="nc">&nbsp;        return envVars.get(envVarName);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public static String getStackName() {
<b class="nc">&nbsp;        String deploymentName = System.getenv(&quot;CAPSTONE_SERVICE_STACK_DEV&quot;);</b>
<b class="nc">&nbsp;        if (deploymentName == null) {</b>
<b class="nc">&nbsp;            deploymentName = System.getenv(&quot;SERVICE_STACK_NAME&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (deploymentName == null) {</b>
<b class="nc">&nbsp;            deploymentName = System.getenv(&quot;STACK_NAME&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (deploymentName == null) {</b>
<b class="nc">&nbsp;            deploymentName = getEnvVarFromFile(&quot;CAPSTONE_SERVICE_STACK_DEV&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (deploymentName == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Could not find the deployment name in environment variables.  Make sure that you have set up your environment variables using the setupEnvironment.sh script.&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return deploymentName;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String getApiEndpint() {
<b class="nc">&nbsp;        String region = System.getenv(&quot;AWS_REGION&quot;);</b>
<b class="nc">&nbsp;        if (region == null) {</b>
<b class="nc">&nbsp;            region = &quot;us-east-1&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String deploymentName = getStackName();</b>
&nbsp;
<b class="nc">&nbsp;        AmazonApiGateway apiGatewayClient = AmazonApiGatewayClientBuilder.defaultClient();</b>
<b class="nc">&nbsp;        GetRestApisRequest request = new GetRestApisRequest();</b>
<b class="nc">&nbsp;        request.setLimit(500);</b>
<b class="nc">&nbsp;        GetRestApisResult result = apiGatewayClient.getRestApis(request);</b>
&nbsp;
<b class="nc">&nbsp;        String endpointId = null;</b>
<b class="nc">&nbsp;        for (RestApi restApi : result.getItems()) {</b>
<b class="nc">&nbsp;            if (restApi.getName().equals(deploymentName)) {</b>
<b class="nc">&nbsp;                endpointId = restApi.getId();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (endpointId == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Could not locate the API Gateway endpoint.  Make sure that your API is deployed and that your AWS credentials are valid.&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return &quot;https://&quot; + endpointId + &quot;.execute-api.&quot; + region + &quot;.amazonaws.com/Prod/&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String postEndpoint(String endpoint, String data) {
<b class="nc">&nbsp;        String api = getApiEndpint();</b>
<b class="nc">&nbsp;        String url = api + endpoint;</b>
&nbsp;
<b class="nc">&nbsp;        HttpClient client = HttpClient.newHttpClient();</b>
<b class="nc">&nbsp;        URI uri = URI.create(url);</b>
<b class="nc">&nbsp;        HttpRequest request = HttpRequest.newBuilder()</b>
<b class="nc">&nbsp;                .uri(uri)</b>
<b class="nc">&nbsp;                .header(&quot;Accept&quot;, &quot;application/json&quot;)</b>
<b class="nc">&nbsp;                .POST(HttpRequest.BodyPublishers.ofString(data))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;        try {
<b class="nc">&nbsp;            HttpResponse&lt;String&gt; httpResponse = client.send(request, HttpResponse.BodyHandlers.ofString());</b>
&nbsp;
<b class="nc">&nbsp;            int statusCode = httpResponse.statusCode();</b>
<b class="nc">&nbsp;            if (statusCode == 200) {</b>
<b class="nc">&nbsp;                return httpResponse.body();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new ApiGatewayException(&quot;GET request failed: &quot; + statusCode + &quot; status code received&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (IOException | InterruptedException e) {</b>
<b class="nc">&nbsp;            return e.getMessage();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String getEndpoint(String endpoint) {
<b class="nc">&nbsp;        String api = getApiEndpint();</b>
<b class="nc">&nbsp;        String url = api + endpoint;</b>
&nbsp;
<b class="nc">&nbsp;        HttpClient client = HttpClient.newHttpClient();</b>
<b class="nc">&nbsp;        URI uri = URI.create(url);</b>
<b class="nc">&nbsp;        HttpRequest request = HttpRequest.newBuilder()</b>
<b class="nc">&nbsp;                .uri(uri)</b>
<b class="nc">&nbsp;                .header(&quot;Accept&quot;, &quot;application/json&quot;)</b>
<b class="nc">&nbsp;                .GET()</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;        try {
<b class="nc">&nbsp;            HttpResponse&lt;String&gt; httpResponse = client.send(request, HttpResponse.BodyHandlers.ofString());</b>
&nbsp;
<b class="nc">&nbsp;            int statusCode = httpResponse.statusCode();</b>
<b class="nc">&nbsp;            if (statusCode == 200) {</b>
<b class="nc">&nbsp;                return httpResponse.body();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new ApiGatewayException(&quot;GET request failed: &quot; + statusCode + &quot; status code received&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (IOException | InterruptedException e) {</b>
<b class="nc">&nbsp;            return e.getMessage();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-04-09 16:53</div>
</div>
</body>
</html>
